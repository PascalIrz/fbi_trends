---
title: "The biological integrity of French rivers did not improve over the last seventeen
  years according to the national Fish-Based-Index (FBI)"
subtitle: Supplementary material
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  word_document:
    toc: true
  bookdown::word_document2: null
  bookdown::html_document2:
    toc: true
    toc_float: true
    number_sections: false
  pdf_document: null
params:
  refnet_start: 2013
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{css, echo = FALSE}
p.caption {
    font-size: 0.9em;
    font-style: italic;
    color: grey;
    margin-right: 10%;
    margin-left: 10%;  
    text-align: justify;
}
```


```{r}
# install packages
# devtools::install_github("pascalirz/aspe")
library(aspe)
library(tidyverse)
library(flextable)

# install custom functions
source("../R/functions.R")
source("../R/gg_temp_fbi.R")
source("../R/gg_box_env_fbi_trend.R")

# load data
load(file = "../processed_data/10_maps.RData")
load(file = "../processed_data/key_figures.RData")
load(file = "../processed_data/30_indicators.RData")
load(file = "../processed_data/40_trends.RData")
```


# Figure S1


```{r, fig.cap = "Annual number of sites surveyed, with a distinction between belonging exclusively to REFNET (green bars), exclusively to REPNET (brown bars) and to both networks."}
fbi_3_cats <- fbi %>% 
  select(annee, pop_id, network) %>% 
  pivot_wider(names_from = network,
              values_from = network,
              values_fill = NA,
              values_fn = ~TRUE,
              ) %>% 
  as.data.frame() %>% 
  mutate(network_3_cats = case_when(
    REPNET & is.na(REFNET) ~ "REPNET",
    is.na(REPNET) & REFNET ~ "REFNET",
    TRUE ~ "Both",
  ))
    
sites_by_years <- fbi_3_cats %>% 
  group_by(annee, network_3_cats) %>% 
  summarise(n_sites = n_distinct(pop_id)) %>% 
  ungroup() %>% 
  mutate(network_3_cats = fct_relevel(network_3_cats, "REFNET", "both"))

fig_s1 <- ggplot(data = sites_by_years,
       aes(x = annee,
           y = n_sites,
           fill = network_3_cats)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(limits = c(0, NA)) +
  labs(x = "Year",
       y = "Number of sites sampled annually",
       fill = "") +
  scale_fill_manual(values = c("green3", "grey", "brown")) +
  theme_bw()

fig_s1
```


# Figure S2

To assess the significance of a monotonous temporal trend for each sampling point, a Mann-Kendall non-parametric test is performed. Sen-Theil slope is then estimated in order to retrieve its sign. As the FBI score is a measure of degradation, both are positively correlated. Hence, if the trend is significant and the sign is positive, FBI scores tend to increase through time, reflecting a degradation of the river. On the contrary, a significant trend with a negative sign indicates an improvement of 'river health'.


```{r, fig.cap = "Map of the Fish-based index trends for the REPNET sites, with the hydrographic basins limits."}
map_data <- points_geo %>%
  left_join(y = fbi_trends_by_point) %>%
  left_join(y = points_ref_status_2_cats) %>% 
  filter(!is.na(trend))

fig_s2 <- ggplot() +
  geom_sf(data = background) +
  geom_sf(data = map_data %>% filter(network == "REPNET"),
          aes(col = trend,
              size = (trend != "No trend"))) +
  scale_color_manual(name = "FBI trend",
                     values = c(
    "Degradation" = "red",
    "Improvement" = "darkgreen",
    "No trend" = "gray"
  )) +
  scale_size_manual(values = c(0.8, 2),
                    guide = 'none') +
  geom_sf(
    data = district_limits,
    size = 0.8,
    col = "darkred",
    alpha = 0
  ) +
  theme(panel.background = element_rect(fill = "lightblue")) +
  coord_sf(xlim = c(-5.4, 8.4),
           ylim = c(42, 51.2),
           expand = FALSE)

fig_s2
```

# Figure S3


```{r, fig.height = 50, fig.width = 12, dpi = 300, fig.cap = "Description of taxa temporal trends using six indicators. Each point represents the annual median value of the indicator. Solid regression lines indicate that the Mann-Kendall trend test is statistically significant. The first two indicators “Density” and “Occupancy_rate” are fully described in the Methods section. The four other indicators are derived from the logistic models developed in Oberdorff et al. (2001) and giving the probability of occurrence of each of the 34 taxa as a function of a set of environmental characteristics. These models were originally fitted exclusively on reference (i.e. least-impacted) sites. We then considered a probability value over 50% as a predicted taxon presence and a probability below this threshold as a predicted taxon absence. These indicators are: (1) the percentage of sites where the taxon is predicted present and observed present (hereafter Confirmed_Presence), (2) the percentage of sites where the taxon taxon is predicted absent but observed present (hereafter Unexpected_Presence), (3) the percentage of sites where the taxon is predicted absent and observed absent (hereafter Confirmed_Absence) and (4) the percentage of sites where the taxon is predicted present but observed absent (hereafter Unexpected_Absence). When analyzed separately, these four indicators reflect temporal trends in the sites habitat suitability (or un-suitability) for a given taxon, according to the models."}

# assembly of the dataframe
sp_trends <- sp_trends %>% 
 # mutate(network = "REFNET") %>% 
  filter(annee >= params$refnet_start | network == "REPNET") %>% 
  # rbind(sp_trends_repnet %>% 
  #         mutate(network = "REPNET")) %>% 
  complete(esp_nom_latin, annee, variable) %>% 
  mutate(esp_nom_latin = str_replace(esp_nom_latin, pattern = "spp", replacement = "spp."))


fig_s3 <- g_sp_trends_indicators2(
  df = sp_trends,
  var_x = annee,
  var_y = value,
  var_col = network,
  var_facet_col = variable,
  var_facet_row = esp_nom_latin,
  var_sig = trend,
  scales = "free_y",
  x_lab = "Year",
  y_lab = "",
  ncol = 6
) 

fig_s3
```

# Table S1

```{r}
contrib <- read.csv2("../raw_data/IPR_params_Especes_Contributives.csv") %>% 
  left_join(y = sp_fbi_conversion %>%
              rename(Taxon = esp_code_alternatif)) %>% 
  mutate(esp_nom_latin = str_replace(esp_nom_latin, pattern = "spp", replacement = "spp.")) %>% 
  select(Taxon = esp_nom_latin,
         nb_total_sp = NTE,
         nb_rheophilic_sp = NER,
         nb_lithophilic_sp = NEL,
         dens_total_indiv = DTI,
         dens_tolerant_indiv = DIT,
         dens_invertivorous_indiv = DII,
         dens_omnivorous_indiv = DIO
         ) %>% 
  distinct() %>% 
  filter(!is.na(Taxon)) 

tab_s1 <- contrib %>%
  mutate(across(nb_total_sp:dens_omnivorous_indiv,
         ~str_replace(., pattern = "O", replacement = "X")),
         across(nb_total_sp:dens_omnivorous_indiv,
         ~str_replace(., pattern = "N", replacement = ""))) %>% 
  rename(total_nb_sp = nb_total_sp,
         total_dens_indiv = dens_total_indiv) %>% 
  flextable::flextable() %>% 
  flextable::italic(j = 1) %>%
  flextable::rotate(i = 1, j = -1, rotation = "btlr", part = "header") %>% 
  flextable::set_caption("List of taxa contributing to each metric making up the FBI.")

tab_s1
```

# Table S2

```{r}
tab_s2 <- 
fbi_trends_exclusive %>% 
  mutate(trend = ifelse(trend == "No trend", "Non-significant", trend)) %>% 
  arrange(network, period, name) %>% 
  select(network, period, variable = name, everything()) %>% 
  flextable::flextable() %>% 
  flextable::autofit() %>% 
  flextable::colformat_double(j = 3:4, digits = 3) %>% 
  flextable::align(align = "center", part = "all") %>% 
  flextable::color(i = ~ network == "REFNET", color = "green3") %>% 
  flextable::color(i = ~ network == "REPNET", color = "brown") %>% 
  flextable::bold(i = ~ trend != "Non-significant") %>% 
  flextable::hline(i = 3) %>% 
  flextable::colformat_double(j = 5, digits = 4) %>% 
  flextable::set_caption("Mann-Kendall test of monotonic temporal trend for the 25, 50 and 75 percentiles of annual FBI score for REPNET and REFNET, 2013-2013, excluding the sites that are shared between these networks. The rows in bold indicate a significant trend (mk_pvalue < 0.05).")

tab_s2
```

# Table S3


```{r}
data <- map_data %>% 
  sf::st_drop_geometry() %>% 
  left_join(y = points_ref_status_2_cats) %>% 
  select(pop_id, network, trend) %>% 
  unique() %>%
  group_by(network) %>% 
  count(trend) 

totals <- data %>% 
  group_by(network) %>% 
  summarise(n_sites = sum(n))

data <- data %>% 
  left_join(y = totals) %>% 
  mutate(prop = 100 * n / n_sites,
         prop = paste0(round(prop, 1), "%"),
         prop = paste0(prop, " (n=", n, ")")) %>% 
  select(-n, -n_sites) %>% 
  pivot_wider(names_from = c(trend, network),
              values_from = prop) %>% 
  select(4, 1, 5, 2, 6, 3)

tab_s3 <- data %>%  
  flextable::flextable() %>% 
  flextable::autofit() %>% 
  flextable::set_caption("Count and proportion of the REPNET and REFNET sites according to the Fish-based index trends.") %>% 
  flextable::set_header_labels(
    Degradation_REPNET = "REPNET",
    Degradation_REFNET = "REFNET",
    Improvement_REPNET = "REPNET",
    Improvement_REFNET = "REFNET",
    `No trend_REPNET` = "REPNET",
    `No trend_REFNET` = "REFNET") %>%
    flextable::align(align = "center", part = "all") %>% 
      flextable::autofit() %>% 
    flextable::add_header_row(values = c("Degradation", "Improvement", "Non-significant"),
      colwidths = c(2, 2, 2)) %>% 
   flextable::align(i = 1, align = "center", part = "header") %>% 
     flextable::color(j = c(2, 4, 6), color = "green3", part = "body") %>% 
   flextable::color(j = c(1, 3, 5), color = "brown", part = "body")

tab_s3
```



